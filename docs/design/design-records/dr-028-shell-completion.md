# DR-028: Shell Completion Support

**Date:** 2025-01-07
**Status:** Accepted
**Category:** CLI Design

## Decision

Support shell completion for bash, zsh, and fish using Cobra's built-in completion system. Provide both manual output and auto-install commands. Complete commands, flags, agent names, task names, and scope arguments.

## What This Means

### Supported Shells

**Three shells supported:**
- bash (most common on Linux)
- zsh (macOS default since Catalina, popular on Linux)
- fish (growing popularity, different syntax)

**Not supported:**
- PowerShell (Windows-focused, not planning Windows support)

**Rationale:**
- Covers >95% of Unix/macOS users
- All three provided free by Cobra framework
- PowerShell requires Windows support we're not planning

### Two Installation Patterns

**Pattern 1: Manual output (for piping/redirection)**
```bash
start completion bash
start completion zsh
start completion fish
```

Prints completion script to stdout. User can redirect to file:
```bash
start completion bash > ~/.bash_completion/start
```

**Pattern 2: Auto-install (convenience command)**
```bash
start completion install bash
start completion install zsh
start completion install fish
```

Automatically installs to standard location:
- Detects OS (macOS vs Linux)
- Uses user directory by default (no sudo required)
- Shows confirmation: "Installed to ~/.zsh/completion/_start"
- Provides reload instructions

**Optional flags for install:**
```bash
start completion install bash --system  # System-wide (requires sudo)
start completion install bash --user    # User only (default)
start completion install bash --path /custom/path/_start  # Custom location
```

### What Gets Completed

**Tier 1: Static completion (free from Cobra)**

Commands and subcommands:
```bash
start <Tab>
# Shows: prompt, task, init, config, doctor, update, completion, help

start config <Tab>
# Shows: show, edit, path, validate, agent, context, task, role

start config agent <Tab>
# Shows: list, add, test, edit, remove, default
```

Flags:
```bash
start --<Tab>
# Shows: --agent, -a, --role, -r, --model, -m, --directory, -d, --verbose, --quiet, -q, --debug, --help, -h, --version, -v

start task --<Tab>
# Shows: --agent, -a, --role, -r, --model, -m, --directory, -d, --verbose, --quiet, -q, --debug, --help, -h, --version, -v
```

**Tier 2: Dynamic completion (high-value, worth implementing)**

Agent names for `--agent` flag:
```bash
start --agent <Tab>
# Shows: claude, gemini, aichat
# Reads from config (global + local merge)
```

Task names for `start task` command:
```bash
start task <Tab>
# Shows: code-review (cr), git-diff-review (gdr), comment-tidy (ct)
# Reads from assets + global + local configs
# Shows alias in parentheses
```

Scope arguments:
```bash
start init <Tab>
# Shows: global, local

start config edit <Tab>
# Shows: global, local

start config task list <Tab>
# Shows: global, local, merged
```

**Not implemented (Tier 3, skip for v1):**
- Model names for `--model` flag (requires parsing agent's model table)
- Context names, role names
- File path completion (shells handle this already)

## Implementation

### Cobra Completion System

**Cobra provides:**
```go
// Auto-generated by Cobra
cmd.CompletionCmd()  // Generates 'completion' subcommand

// Custom completions via ValidArgsFunction
&cobra.Command{
    ValidArgsFunction: func(cmd *cobra.Command, args []string, toComplete string) ([]string, cobra.ShellCompDirective) {
        // Return completion suggestions
        return suggestions, cobra.ShellCompDirectiveNoFileComp
    },
}
```

**We implement:**
1. Add `completion` command (Cobra generates base)
2. Add `completion install` subcommand (our custom logic)
3. Add `ValidArgsFunction` for dynamic completions

### Dynamic Completion Functions

**Agent names completion:**
```go
func completeAgentNames(cmd *cobra.Command, args []string, toComplete string) ([]string, cobra.ShellCompDirective) {
    cfg := loadConfig()  // Load global + local
    agents := cfg.GetAgentNames()

    return agents, cobra.ShellCompDirectiveNoFileComp
}
```

**Task names completion:**
```go
func completeTaskNames(cmd *cobra.Command, args []string, toComplete string) ([]string, cobra.ShellCompDirective) {
    tasks := loadTasks()  // Assets + global + local

    suggestions := []string{}
    for _, task := range tasks {
        if task.Alias != "" {
            suggestions = append(suggestions, fmt.Sprintf("%s\t(%s)", task.Name, task.Alias))
        } else {
            suggestions = append(suggestions, task.Name)
        }
    }

    return suggestions, cobra.ShellCompDirectiveNoFileComp
}
```

**Scope values completion:**
```go
func completeScopeValues(cmd *cobra.Command, args []string, toComplete string) ([]string, cobra.ShellCompDirective) {
    return []string{"global", "local"}, cobra.ShellCompDirectiveNoFileComp
}

func completeScopeWithMerged(cmd *cobra.Command, args []string, toComplete string) ([]string, cobra.ShellCompDirective) {
    return []string{"global", "local", "merged"}, cobra.ShellCompDirectiveNoFileComp
}
```

### Auto-Install Implementation

**Standard locations by shell:**

```go
var completionPaths = map[string]map[string]string{
    "bash": {
        "user":   "~/.bash_completion",
        "system": "/etc/bash_completion.d/start",
    },
    "zsh": {
        "user":   "~/.zsh/completion/_start",
        "system": "/usr/local/share/zsh/site-functions/_start",
    },
    "fish": {
        "user":   "~/.config/fish/completions/start.fish",
        "system": "/usr/share/fish/vendor_completions.d/start.fish",
    },
}
```

**Install logic:**
```go
func installCompletion(shell string, scope string) error {
    // 1. Get path for shell + scope
    path := getCompletionPath(shell, scope)

    // 2. Expand ~ if needed
    path = expandHomePath(path)

    // 3. Create parent directory
    if err := os.MkdirAll(filepath.Dir(path), 0755); err != nil {
        return err
    }

    // 4. Generate completion script
    var buf bytes.Buffer
    rootCmd.GenCompletionScript(shell, &buf)

    // 5. Write to file
    if err := os.WriteFile(path, buf.Bytes(), 0644); err != nil {
        return err
    }

    // 6. Show success + reload instructions
    fmt.Printf("✓ Completion installed to: %s\n", path)
    fmt.Printf("\nReload your shell:\n")
    fmt.Printf("  %s\n", getReloadInstruction(shell))

    return nil
}
```

**Reload instructions by shell:**
```go
func getReloadInstruction(shell string) string {
    switch shell {
    case "bash":
        return "source ~/.bashrc"
    case "zsh":
        return "source ~/.zshrc"
    case "fish":
        return "source ~/.config/fish/config.fish"
    }
}
```

## User Experience

### Manual Installation (bash example)

```bash
$ start completion bash > ~/.bash_completion/start

# Add to .bashrc
$ echo 'source ~/.bash_completion/start' >> ~/.bashrc

# Reload
$ source ~/.bashrc

# Test
$ start <Tab>
prompt  task  init  config  doctor  update  completion  help
```

### Auto-Install (zsh example)

```bash
$ start completion install zsh

Creating directory: /Users/grant/.zsh/completion
✓ Completion installed to: /Users/grant/.zsh/completion/_start

Reload your shell:
  source ~/.zshrc

Or start a new terminal session.

$ source ~/.zshrc

# Test
$ start --agent <Tab>
claude  gemini  aichat
```

### System-Wide Install (fish example)

```bash
$ sudo start completion install fish --system

✓ Completion installed to: /usr/share/fish/vendor_completions.d/start.fish

Reload your shell:
  source ~/.config/fish/config.fish

Fish completion is now available for all users.
```

### Completion in Action

**Command completion:**
```bash
$ start con<Tab>
$ start config   # Completed

$ start config ag<Tab>
$ start config agent   # Completed

$ start config agent li<Tab>
$ start config agent list   # Completed
```

**Flag completion:**
```bash
$ start --ag<Tab>
$ start --agent   # Completed

$ start --agent <Tab>
claude  gemini  aichat

$ start --agent cl<Tab>
$ start --agent claude   # Completed
```

**Task completion:**
```bash
$ start task <Tab>
code-review (cr)     git-diff-review (gdr)     comment-tidy (ct)     doc-review (dr)

$ start task co<Tab>
$ start task code-review   # Completed

# Also works with aliases
$ start task cr<Tab>
$ start task code-review   # Completed (matched alias)
```

**Scope completion:**
```bash
$ start init <Tab>
global  local

$ start config edit <Tab>
global  local

$ start config task list <Tab>
global  local  merged
```

## Command Specification

### start completion

**Synopsis:**
```bash
start completion <shell>
start completion install <shell> [flags]
```

**Arguments:**

`<shell>` - Shell type (required)
- `bash` - Bash completion script
- `zsh` - Zsh completion script
- `fish` - Fish completion script

**Subcommands:**

`install` - Auto-install completion to standard location
- `--user` - Install to user directory (default)
- `--system` - Install system-wide (requires sudo)
- `--path <path>` - Install to custom path

**Examples:**

```bash
# Print to stdout
start completion bash
start completion zsh

# Auto-install (user directory)
start completion install bash
start completion install zsh

# System-wide install
sudo start completion install bash --system

# Custom path
start completion install zsh --path ~/.my-completions/_start
```

**Output (manual):**
Prints completion script to stdout (suitable for redirection).

**Output (install):**
```
Creating directory: /Users/grant/.bash_completion.d
✓ Completion installed to: /Users/grant/.bash_completion.d/start

Add to your .bashrc:
  source ~/.bash_completion.d/start

Reload your shell:
  source ~/.bashrc
```

**Exit codes:**
- 0 - Success (script printed or installed)
- 1 - Invalid shell argument
- 2 - Permission error (install failed)
- 3 - Invalid flags

## Benefits

- ✅ **Better UX** - Faster command entry via Tab completion
- ✅ **Discoverability** - Users discover subcommands and flags via Tab
- ✅ **Fewer typos** - Completion prevents command/flag mistakes
- ✅ **Dynamic values** - Agent and task names completed from config
- ✅ **Professional** - Expected feature for modern CLI tools
- ✅ **Easy install** - Auto-install removes complexity
- ✅ **Free implementation** - Cobra does heavy lifting

## Trade-offs Accepted

- ❌ Requires one-time setup by user (acceptable: common for CLI tools)
- ❌ Different per shell (acceptable: auto-install handles this)
- ❌ Doesn't complete model names (acceptable: less frequently used)
- ❌ No PowerShell support (acceptable: not planning Windows support)

## Documentation

### README section

```markdown
## Shell Completion

`start` supports Tab completion for bash, zsh, and fish.

**Quick setup:**
```bash
# Bash
start completion install bash
source ~/.bashrc

# Zsh
start completion install zsh
source ~/.zshrc

# Fish
start completion install fish
source ~/.config/fish/config.fish
```

**What gets completed:**
- Commands: `start config <Tab>`
- Flags: `start --<Tab>`
- Agents: `start --agent <Tab>` → shows configured agents
- Tasks: `start task <Tab>` → shows available tasks
- Scopes: `start init <Tab>` → `global`, `local`

**Manual installation:**
```bash
# For custom setups
start completion bash > /path/to/completion
source /path/to/completion
```
```

### Help text

```bash
$ start completion --help

Generate shell completion scripts

Usage:
  start completion <shell>
  start completion install <shell> [flags]

Shells:
  bash    Bash completion
  zsh     Zsh completion
  fish    Fish completion

Examples:
  # Print to stdout
  start completion bash > ~/.bash_completion/start

  # Auto-install (recommended)
  start completion install bash
  start completion install zsh

  # System-wide install
  sudo start completion install bash --system

Flags:
  --user          Install to user directory (default)
  --system        Install system-wide (requires sudo)
  --path <path>   Install to custom path
  -h, --help      Help for completion

After installation, reload your shell or start a new session.
```

## Related Decisions

- [DR-006](./dr-006-cobra-cli.md) - Cobra framework (provides completion system)

## Future Considerations

**Could add in future:**

**Model name completion:**
```bash
start --agent claude --model <Tab>
# Shows: haiku, sonnet, opus
# Requires parsing agent's model table
```

**Context name completion:**
```bash
start config context edit <Tab>
# Shows: environment, index, project, agents
```

**File path completion:**
- Shells already do this, but we could enhance for specific file types
- Example: `start config edit <Tab>` → only show .toml files

**Current stance:** Tier 1 + Tier 2 is sufficient for v1. Add Tier 3 if users request it.
